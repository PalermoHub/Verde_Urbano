name: Download Google Sheets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # Ogni giorno alle 6:00 UTC

jobs:
  download-sheets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Backup vecchi dati
        run: |
          mkdir -p backups
          if [ -d "dati" ] && [ "$(ls -A dati 2>/dev/null)" ]; then
            BACKUP_DATE=$(date +'%Y%m%d_%H%M%S')
            mkdir -p "backups/$BACKUP_DATE"
            cp dati/*.csv "backups/$BACKUP_DATE/" 2>/dev/null || true
            echo "‚úÖ Backup creato in backups/$BACKUP_DATE"
          else
            echo "‚ÑπÔ∏è Nessun dato esistente da backuppare"
          fi

      - name: Download Google Sheets
        run: |
          mkdir -p dati
          
          BASE_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSunsI5HEZofRXsbtdjz7AJYYYlXhPVGwBVgvoFzlPY7c1G7MVvVkjTcT8sNWVfBTrx1QBj08ueBbYB/pub"
          
          # Array di gid e nomi file (modifica i nomi secondo le tue esigenze)
          declare -A SHEETS=(
            ["253723192"]="Query - Rilievo semplificato verde urbano"
            ["1617221218"]="Quadrante"
            ["1122783976"]="Tavole"
            ["641613516"]="Specie_Arboree_Palermo"
            ["52685852"]="Elenco_prezzi_2024"
            ["1143303012"]="Specie"
            ["778487951"]="CPC"
            ["1105304956"]="Costo_lavori_vie"
            ["1370911247"]="O2-CO2"
            ["832007978"]="Sito_impianto"
            ["1088493025"]="Altezza-Diametro"
            ["1990469629"]="Altezza"
            ["1758798851"]="CO2-Diametro"
          )
          
          for gid in "${!SHEETS[@]}"; do
            filename="${SHEETS[$gid]}"
            echo "üì• Downloading $filename (gid: $gid)..."
            curl -sL "${BASE_URL}?gid=${gid}&single=true&output=csv" -o "dati/${filename}.csv"
            
            if [ -s "dati/${filename}.csv" ]; then
              echo "   ‚úÖ $filename.csv scaricato ($(wc -l < "dati/${filename}.csv") righe)"
            else
              echo "   ‚ö†Ô∏è Attenzione: $filename.csv √® vuoto o non scaricato"
            fi
          done

      - name: Pulizia vecchi backup (mantieni ultimi 7)
        run: |
          cd backups 2>/dev/null || exit 0
          ls -dt */ 2>/dev/null | tail -n +8 | xargs rm -rf 2>/dev/null || true
          echo "üßπ Mantenuti solo gli ultimi 7 backup"

      - name: Commit e push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dati/ backups/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Nessuna modifica da committare"
          else
            git commit -m "üìä Aggiornamento dati $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "‚úÖ Modifiche pushate"
          fi