name: Accordo Quadro - CUP D71G23000050001

on:
  workflow_dispatch:
  schedule:
    - cron: '00 17 * * *'  # Ogni giorno alle 6:00 UTC

jobs:
  download-sheets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout branch main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Backup vecchi dati
        run: |
          mkdir -p backup
          if [ -d "dati" ] && [ "$(ls -A dati 2>/dev/null)" ]; then
            BACKUP_DATE=$(date +'%Y%m%d_%H%M%S')
            mkdir -p "backup/$BACKUP_DATE"
            cp dati/*.csv "backup/$BACKUP_DATE/" 2>/dev/null || true
            echo "‚úÖ Backup creato in backup/$BACKUP_DATE"
          else
            echo "‚ÑπÔ∏è Nessun dato esistente da backuppare"
          fi

      - name: Download Google Sheets
        run: |
          mkdir -p dati
          
          BASE_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSunsI5HEZofRXsbtdjz7AJYYYlXhPVGwBVgvoFzlPY7c1G7MVvVkjTcT8sNWVfBTrx1QBj08ueBbYB/pub"
          
          # Array di gid e nomi file
          declare -A SHEETS=(
            ["253723192"]="01_query_rilievo_semplificato"
            ["1617221218"]="02_quadrante"
            ["1122783976"]="03_tavole"
            ["641613516"]="04_foto"
            ["50914242"]="05_specie_arboree_palermo"
            ["52685852"]="06_elenco_prezzi_2024"
            ["1143303012"]="07_specie"
            ["778487951"]="08_cpc"
            ["1105304956"]="09_costo_lavori_vie"
            ["1370911247"]="10_o2_co2"
            ["832007978"]="11_sito_impianto"
            ["1088493025"]="12_altezza_diametro"
            ["1990469629"]="13_altezza"
            ["1758798851"]="14_co2_diametro"
            ["504168826"]="15_num_foglie"
            ["425906037"]="16_tot_foglie"
            ["1621206908"]="17_query_web"
          )
          
          for gid in "${!SHEETS[@]}"; do
            filename="${SHEETS[$gid]}"
            echo "üì• Downloading $filename (gid: $gid)..."
            curl -sL "${BASE_URL}?gid=${gid}&single=true&output=csv" -o "dati/${filename}.csv"
            
            if [ -s "dati/${filename}.csv" ]; then
              echo "   ‚úÖ $filename.csv scaricato ($(wc -l < "dati/${filename}.csv") righe)"
            else
              echo "   ‚ö†Ô∏è Attenzione: $filename.csv √® vuoto o non scaricato"
            fi
          done

      - name: Pulizia vecchi backup (mantieni ultimi 7)
        run: |
          cd backup 2>/dev/null || exit 0
          ls -dt */ 2>/dev/null | tail -n +8 | xargs rm -rf 2>/dev/null || true
          echo "üßπ Mantenuti solo gli ultimi 7 backup"

      - name: Commit e push su main
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dati/ backup/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Nessuna modifica da committare"
          else
            git commit -m "üìä Aggiornamento dati $(date +'%Y-%m-%d %H:%M')"
            git push origin main
            echo "‚úÖ Modifiche pushate su main"
          fi
