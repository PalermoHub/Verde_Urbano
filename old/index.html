<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title> üå≥ Demo prototipale</title>
	<meta name="description" content="Questa √® una demo prototipale che mostra i dati di monitoraggio relativi a una singola strada. Il progetto completo di cui fa parte √® molto pi√π articolato e comprende ulteriori strade, zone e funzionalit√† avanzate non ancora rappresentate in questa versione.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
hr {
    border: 0;
    height: 1px;
    background: #1e8449;
    background-image: linear-gradient(to right, #eee, #1e8449, #eee);
    margin-top: 20px;
    margin-bottom: 20px;
}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        header {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            color: white;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header > div:first-child {
            flex: 1;
        }
        header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            font-weight: 700;
        }
        header p {
            font-size: 15px;
            opacity: 0.95;
        }
        /* NUOVO LAYOUT: Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
        }

        /* HAMBURGER BUTTON */
        .hamburger-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            margin-right: 10px;
        }
        .hamburger-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        /* SIDEBAR MODAL (left) */
        .sidebar-modal {
            position: fixed;
            top: 0;
            left: -100%;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow-y: auto;
            transition: left 0.3s ease;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }
        .sidebar-modal.active {
            left: 0;
        }

        .sidebar-content {
            margin-top: 40px;
        }
        .sidebar-modal h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #313131;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }

        /* TREE DETAILS MODAL (right) */
        .tree-details-modal {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow-y: auto;
            transition: right 0.3s ease;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }
        .tree-details-modal.active {
            right: 0;
        }

        .tree-details-content {
            margin-top: 40px;
        }

        /* DATAVIZ MODAL (right, wider) */
        .dataviz-modal {
            position: fixed;
            top: 0;
            right: -100%;
            width: 75%;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow-y: auto;
            transition: right 0.3s ease;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }
        .dataviz-modal.active {
            right: 0;
        }

        /* CLOSE BUTTON for modals */
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
        }
        .close-btn:hover {
            background: #c0392b;
            transform: rotate(90deg);
        }
        .filter-group {
            margin-bottom: 18px;
        }
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }
        .filter-info {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            font-style: italic;
        }
        .stats-box {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #fff;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .stat-value {
            font-weight: 700;
            font-size: 14px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            flex: 1;
            padding: 11px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px);
            /*background: #1e8449;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);*/
        }
        button.secondary {
            background: #95a5a6;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        /* MAPPA FULL-WIDTH */
        #map {
            width: 100%;
            height: 800px;
            background: white;
        }
        footer {
            background: #f9f9f9;
            border-top: 2px solid #27ae60;
            padding: 25px 20px;
            margin-top: 40px;
            text-align: center;
            color: #555;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        footer h3 {
            color: #27ae60;
            font-size: 15px;
            margin-bottom: 12px;
            font-weight: 700;
        }
        footer p {
            max-width: 800px;
            margin: 0 auto;
            color: #666;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 350px;
        }
        .chart-box h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #313131;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .tree-details-modal h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        .detail-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }
        .detail-label {
            font-size: 11px;
            color: #888;
            font-weight: 700;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .detail-value {
            font-size: 14px;
            color: #333;
            word-break: break-word;
            font-weight: 500;
        }
        .environmental-stats-section {
            grid-column: 1/-1;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #fff;
            margin-top: 15px;
        }
        .environmental-stats-section .detail-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .environmental-stats-section .detail-value {
            color: white;
            font-weight: 600;
        }
        .stat-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .stat-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .stat-section-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-section-row .detail-label {
            display: inline;
            margin: 0;
            text-transform: uppercase;
            font-size: 10px;
        }
        .stat-section-row .detail-value {
            display: inline;
            font-size: 13px;
        }
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
			display: none;
        }
        .legend h4 {
            color: #313131;
            margin-bottom: 10px;
            font-size: 13px;
        }
        /* Modale Info */
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .info-icon:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            animation: fadeIn 0.3s ease;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
       /**/ .modal-close:hover {
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 30px;
        }
        .modal-section {
            margin-bottom: 25px;
        }
        .modal-section:last-child {
            margin-bottom: 0;
        }
        .modal-section h3 {
            color: #27ae60;
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-section p {
            color: #555;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .modal-section ul {
            margin-left: 20px;
            color: #555;
            font-size: 14px;
            line-height: 1.8;
        }
        .modal-section li {
            margin-bottom: 6px;
        }
        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .feature-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .feature-icon {
            color: #27ae60;
            font-size: 18px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .feature-text {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }
        .legend-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .info-banner {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #2e7d32;
            margin-bottom: 15px;
        }
        /* RESPONSIVE */
        @media (max-width: 768px) {
            header h1 {
                font-size: 20px;
            }
            header p {
                font-size: 12px;
            }
            .hamburger-btn,
            .info-icon {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
            .sidebar-modal {
                width: 280px;
            }
            .tree-details-modal {
                width: 100%;
            }
            .dataviz-modal {
                width: 100%;
            }
            #map {
                height: 400px;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 15px;
            }
            header h1 {
                font-size: 16px;
            }
            .sidebar-modal {
                width: 260px;
            }
            #map {
                height: 350px;
            }
        }
        .no-data {
            padding: 40px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1 id="pageTitle"><i class="fas fa-tree"></i>  Demo prototipale | Verde Urbano</h1>
            <p>Palermo 2025 - Monitoraggio e analisi dello stato di salute del verde urbano</p>
        </div>
        <div class="header-right">
            <div class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <div class="info-icon" id="infoBtn" title="Informazioni su questa app"><i class="fas fa-circle-info"></i></div>
        </div>
    </header>

    <!-- Modale Info -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-circle-info"></i> Come Funziona</h2>
                <button class="modal-close" onclick="closeInfoModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3><i class="fas fa-location-dot"></i> Che cos'√®</h3>
                    <p>Una dashboard interattiva per visualizzare e analizzare i dati degli alberi presenti lungo Viale Emilia a Palermo. Uno strumento di monitoraggio dello stato di salute della vegetazione urbana della citt√†.</p>
                </div>

                <div class="modal-section">
                    <h3><i class="fas fa-bullseye"></i> Funzionalit√† Principali</h3>
                    <div class="feature-list">
                        <div class="feature-item">
                            <span class="feature-icon"><i class="fas fa-map"></i></span>
                            <span class="feature-text"><strong>Mappa Interattiva</strong> - Visualizza la posizione esatta di ogni albero con zoom e pan</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon"><i class="fas fa-magnifying-glass"></i></span>
                            <span class="feature-text"><strong>Filtri Avanzati</strong> - Filtra per specie, stato di salute (CPC), sito, altezza e diametro</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon"><i class="fas fa-chart-bar"></i></span>
                            <span class="feature-text"><strong>Grafici Dinamici</strong> - Analizza distribuzioni per altezza, salute, specie e localizzazione</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon"><i class="fas fa-chart-line"></i></span>
                            <span class="feature-text"><strong>Statistiche in Tempo Reale</strong> - Dati sempre aggiornati in base ai filtri applicati</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon"><i class="fas fa-search"></i></span>
                            <span class="feature-text"><strong>Dettagli Alberi</strong> - Informazioni complete per ogni esemplare selezionato</span>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3><i class="fas fa-clipboard-list"></i> Classificazione CPC (Stato di Salute)</h3>
                    <ul>
                        <li><strong style="color: #2ecc71;"><i class="fas fa-circle"></i> B (bassa)</strong> - Difetti lievi, fattore di sicurezza adeguato; monitoraggi periodici e interventi minimi.</li>
                        <li><strong style="color: #f39c12;"><i class="fas fa-circle"></i> C (moderata)</strong> - Anomalie significative, sicurezza ridotta; interventi colturali obbligatori e controlli frequenti.</li>
						<li><strong style="color: #c164a1;"><i class="fas fa-circle"></i> C/D (elevata)</strong> - Difetti gravi, sicurezza esaurita; rimozione immediata o messa in sicurezza area.</li>
                        <li><strong style="color: #e74c3c;"><i class="fas fa-circle"></i> D (estrema)</strong> - Rischio intermedio con evoluzione incerta; approfondimenti e interventi per stabilizzare.</li>
                    </ul>
                </div>

                <div class="modal-section">
                    <h3><i class="fas fa-lightbulb"></i> Come Usarla</h3>
                    <ol style="margin-left: 20px; color: #555; font-size: 14px; line-height: 1.8;">
                        <li>Usa i <strong>filtri a sinistra</strong> per restringere i dati (facoltativo)</li>
                        <li>Clicca su <strong>"Applica"</strong> per aggiornare mappa e grafici</li>
                        <li>Clicca su un <strong>marcatore della mappa</strong> per visualizzare i dettagli completi dell'albero</li>
                        <li>Leggi i <strong>grafici statistici</strong> per analizzare distribuzioni e trend</li>
                        <li>Usa <strong>"Ripristina"</strong> per azzerare tutti i filtri</li>
                    </ol>
                </div>

                <div class="modal-section">
                    <h3><i class="fas fa-wrench"></i> Parametri Visualizzati</h3>
                    <ul>
                        <li><strong>ID Albero</strong> - Codice identificativo univoco</li>
                        <li><strong>Specie Botanica</strong> - Nome scientifico e comune dell'albero</li>
                        <li><strong>Altezza</strong> - In metri (m)</li>
                        <li><strong>Diametro</strong> - A petto d'uomo (dpu) in centimetri (cm)</li>
                        <li><strong>CPC</strong> - Classificazione dello stato di salute</li>
                        <li><strong>Sito</strong> - Localizzazione lungo Viale Emilia</li>
                        <li><strong>Codice Lavorazione</strong> - Interventi programmati/effettuati</li>
                    </ul>
                </div>
				<hr>
				 <div class="modal-section">
                    <h3><i class="fas fa-leaf"></i> Calcolo Benefici Ambientali (CO‚ÇÇ e O‚ÇÇ)</h3>
                    <p style="margin-bottom: 12px;">I valori di <strong>CO‚ÇÇ catturata</strong> e <strong>O‚ÇÇ emesso</strong> sono calcolati mediante metodologie scientifiche standardizzate. Consulta i seguenti riferimenti:</p>
                    <ul>
                        <li><strong><a href="https://www.fs.fed.us/nrs/pubs/jrnls/2012/nrs_2012_nowak_001.pdf" target="_blank" style="color: #27ae60; text-decoration: underline;">USDA Forest Service - Carbon Storage and Sequestration by Municipal Trees (2012)</a></strong>
                            <br><span style="font-size: 12px; color: #666;">Nowak, D.J. & Greenfield, E.J. Studio fondamentale su sequestro di carbonio urbano</span>
                        </li>
                        <li><strong><a href="https://www.fs.fed.us/nrs/tools/" target="_blank" style="color: #27ae60; text-decoration: underline;">USDA Forest Service - Urban Forest Carbon Tools</a></strong>
                            <br><span style="font-size: 12px; color: #666;">Strumenti online per quantificare benefici ambientali del verde urbano</span>
                        </li>
                        <li><strong><a href="https://www.sciencedirect.com/science/article/pii/S0301479711001253" target="_blank" style="color: #27ae60; text-decoration: underline;">Escobedo et al. (2011) - Ecological benefits of green infrastructure</a></strong>
                            <br><span style="font-size: 12px; color: #666;">Environmental Pollution, 159(7), 1628-1635. Benefici ecologici dell'infrastruttura verde urbana</span>
                        </li>
                        <li><strong><a href="https://www.frontiersin.org/articles/10.3389/fenvs.2015.00069/full" target="_blank" style="color: #27ae60; text-decoration: underline;">Mullaney et al. (2015) - Urban green infrastructure: From theory to practice</a></strong>
                            <br><span style="font-size: 12px; color: #666;">Frontiers in Environmental Science, 3(69). Connessioni tra teoria e applicazione pratica</span>
                        </li>
                        <li><strong><a href="https://www.itreetools.org/" target="_blank" style="color: #27ae60; text-decoration: underline;">i-Tree Tools - Free Urban Forest Analysis Software</a></strong>
                            <br><span style="font-size: 12px; color: #666;">Software gratuito per analizzare e quantificare i benefici della foresta urbana</span>
                        </li>
                    </ul>
					
					<hr>
				 <div class="modal-section">
                    <h3><i class="fas fa-leaf"></i> Metodologia per la Stima del Numero di Foglie del Patrimonio Arboreo</h3>
                    <p style="margin-bottom: 12px;">La quantificazione del numero di foglie per ciascun esemplare arboreo censito √® stata effettuata mediante un modello di calcolo che integra parametri dendrometrici rilevati in campo con coefficienti botanici specifici per specie.</p>
                    <ul>
                        <li>Per ogni albero sono stati considerati i seguenti parametri misurati: altezza (h) espressa in metri, diametro del tronco a petto d'uomo (DBH) espresso in centimetri, e classificazione fitosanitaria (CPC) che indica lo stato di salute dell'esemplare. A questi dati sono stati associati coefficienti standard ricavati dalla letteratura scientifica e specifici per ciascuna specie arborea, tra cui: il Leaf Area Index base (LAI_base), il coefficiente moltiplicativo del diametro (coeff_diametro), il coefficiente moltiplicativo dell'altezza (coeff_altezza) e la densit√† fogliare espressa in numero di foglie per metro quadrato di chioma (densita_foglie).
                        </li>
                        <li><strong><a href="https://www.fs.fed.us/nrs/tools/" target="_blank" style="color: #27ae60; text-decoration: underline;">USDA Forest Service - Urban Forest Carbon Tools</a></strong>
                            <br><span style="font-size: 12px; color: #666;">Strumenti online per quantificare benefici ambientali del verde urbano</span>
                        </li>
                        <li>Il modello di calcolo adottato prevede l'applicazione della seguente formula: N_Foglie = LAI_base √ó (DBH/100)^coeff_diametro √ó h^coeff_altezza √ó densita_foglie √ó fattore_stagionale √ó fattore_CPC. Il fattore stagionale tiene conto della fenologia della specie, differenziando tra specie decidue (che perdono completamente le foglie in inverno), sempreverdi (che mantengono il 90-95% delle foglie durante tutto l'anno) e semi-decidue. Il fattore CPC introduce una correzione basata sullo stato di salute dell'albero, con valori compresi tra 1,0 per esemplari in condizioni ottimali e 0,5 per esemplari in condizioni critiche.
                        </li>
                        <li>Tale approccio consente di ottenere una stima del numero di foglie per ciascuna delle quattro stagioni (primavera, estate, autunno, inverno), fornendo un dato quantitativo utile per valutazioni ecosistemiche quali la capacit√† di assorbimento di CO‚ÇÇ, la produzione di ossigeno e i servizi di regolazione del microclima urbano.
                        </li>
                    </ul>
					</div>
                    <p style="margin-top: 12px; padding: 10px; background: #e8f5e9; border-left: 3px solid #27ae60; border-radius: 4px; font-size: 12px; color: #2e7d32;">
                        <strong>Nota metodologica:</strong> I coefficienti sono stati adattati per il clima mediterraneo di Palermo/Sicilia in base alla letteratura scientifica consolidata. L'accuratezza √® ¬±15% (margine standard per modelli urbani).
                    </p>
                </div>
				<hr>
                <div class="modal-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> Disclaimer</h3>
                    <p style="background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; border-radius: 6px; color: #856404;">
                        <strong>Natura della Demo</strong><br>
                        Questa √® una <strong>demo prototipale</strong> che mostra i dati di monitoraggio relativi a una singola strada (Viale Emilia). Il progetto completo di cui fa parte √® molto pi√π articolato e comprende ulteriori strade, zone e funzionalit√† avanzate non ancora rappresentate in questa versione.
                    </p>
                    <p style="margin-top: 12px;">
                        <strong>Note su Descrizioni e Parametri</strong><br>
                        Le descrizioni tecniche, i parametri fitosanitari (altezza, diametro, CPC) e le classificazioni indicate in questa dashboard sono <strong>puramente esemplificativi e di natura standard</strong>. Essi <strong>non fanno riferimento</strong> a nessun elenco prezzi regionale o nazionale, n√© rappresentano valori ufficiali di alcuna amministrazione pubblica o privata.
                    </p>
                    <p style="margin-top: 12px;">
                        <strong>Scopo Educativo e Prototipale</strong><br>
                        Questa applicazione √® stata sviluppata a scopo dimostrativo e educativo per illustrare le potenzialit√† dei sistemi di monitoraggio urbano e gestione dati geospaziali. I dati visualizzati sono sintetici e non rappresentano situazioni reali certificate.</p>
						<hr><br>
                    <p><strong>Elaborazione dati:</strong> <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano</a> </p>
 <p><strong>Sviluppo tecnico:</strong> <a href="https://www.linkedin.com/in/gbvitrano/" title="@gbvitrano" target="_blank">@gbvitrano</a> - <a href="https://claude.ai" target="_blank">Claude AI (Anthropic)</a></p>					
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Mappa Full-Width -->
        <div id="map"></div>
    </div>

    <!-- Sidebar Modal (left) -->
    <div class="sidebar-modal" id="sidebarPanel">
        <button class="close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        <div class="sidebar-content">
            <div class="info-banner">
                <i class="fas fa-info-circle"></i> I filtri aggiornano mappa e grafici in tempo reale
            </div>

            <h2><i class="fas fa-search"></i> Filtri</h2>

<!-- Territorio -->

            <div class="filter-group">
                <label>Odonimo (Strada)</label>
                <select id="odonimoFilter" onchange="applyFilters()">
                    <option value="">Tutte le strade</option>
                </select>
                <div class="filter-info" id="odonimoInfo"></div>
            </div>

            <div class="filter-group">
                <label>Circoscrizione</label>
                <select id="circoscrizioneFilter" onchange="applyFilters()">
                    <option value="">Tutte le circoscrizioni</option>
                </select>
                <div class="filter-info" id="circoscrizioneInfo"></div>
            </div>

            <div class="filter-group">
                <label>Quartiere</label>
                <select id="quartiereFilter" onchange="applyFilters()">
                    <option value="">Tutti i quartieri</option>
                </select>
                <div class="filter-info" id="quartiereInfo"></div>
            </div>

            <div class="filter-group">
                <label>UPL</label>
                <select id="uplFilter" onchange="applyFilters()">
                    <option value="">Tutte le UPL</option>
                </select>
                <div class="filter-info" id="uplInfo"></div>
            </div>

<hr>

<!-- Alberi -->
            <div class="filter-group">
                <label>Specie Botanica</label>
                <select id="specieFilter" onchange="applyFilters()">
                    <option value="">Tutte le specie</option>
                </select>
                <div class="filter-info" id="specieInfo"></div>
            </div>

            <div class="filter-group">
                <label>Stato Salute (CPC)</label>
                <select id="cpcFilter" onchange="applyFilters()">
                    <option value="">Tutti</option>
                    <option value="B">B - Bassa</option>
                    <option value="C">C - Moderata</option>
                    <option value="C/D">C/D - Elevata</option>
                    <option value="D">D - Estrema</option>
                </select>
                <div class="filter-info" id="cpcInfo"></div>
            </div>

            <div class="filter-group">
                <label>Dimora</label>
                <select id="siteFilter" onchange="applyFilters()">
                    <option value="">Tutti i siti</option>
                </select>
                <div class="filter-info" id="siteInfo"></div>
            </div>

            <div class="filter-group">
                <label>Altezza Minima (m)</label>
                <input type="range" id="minHeight" min="0" max="16" value="0" onchange="updateHeightLabel(); applyFilters()">
                <div class="filter-info">Min: <span id="minHeightLabel">0</span>m</div>
            </div>

            <div class="filter-group">
                <label>Diametro Minimo (cm)</label>
                <input type="range" id="minDiameter" min="0" max="137" value="0" onchange="updateDiameterLabel(); applyFilters()">
                <div class="filter-info">Min: <span id="minDiameterLabel">0</span>cm</div>
            </div>

            <hr>

<!-- Pulsanti -->

            <div class="button-group">
                <button onclick="applyFilters()">‚úì Applica</button>
                <button class="secondary" onclick="resetFilters()">‚Ü∫ Ripristina</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <button style="padding: 11px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;" onclick="downloadRelazione()" title="Scarica la Relazione Tecnica">
                    <i class="fas fa-file-pdf"></i> Relazione
                </button>
                <button style="padding: 11px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.3s;" onclick="printMapPdf()" title="Stampa la mappa in PDF">
                    <i class="fas fa-map"></i> Mappa PDF
                </button>
            </div>

            <h2 style="margin-top: 25px;"><i class="fas fa-chart-simple"></i> Statistiche</h2>
            <div class="stats-box">
                <div class="stat-row">
                    <span>Alberi Visualizzati</span>
                    <span class="stat-value" id="statFiltered">0</span>
                </div>
                <div class="stat-row">
                    <span>Totale Dataset</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
                <div class="stat-row">
                    <span>Altezza Media</span>
                    <span class="stat-value" id="statAvgHeight">-</span>
                </div>
                <div class="stat-row">
                    <span>Diametro Medio</span>
                    <span class="stat-value" id="statAvgDiameter">-</span>
                </div>
                <div class="stat-row">
                    <span>Specie Presenti</span>
                    <span class="stat-value" id="statSpecies">0</span>
                </div>
            </div>

            <h2 style="margin-top: 25px;"><i class="fas fa-map-location-dot"></i> Dati Territorio</h2>
            <div class="stats-box" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                <div class="stat-row">
                    <span>Vie interessate:</span>
                    <span class="stat-value" id="statTotalStrade">0</span>
                </div>
                <div class="stat-row">
                    <span>UPL:</span>
                    <span class="stat-value" style="font-size: 11px;" id="statAlberiPerUPL">-</span>
                </div>
                <div class="stat-row">
                    <span>Quartiere:</span>
                    <span class="stat-value" style="font-size: 11px;" id="statAlberiPerQuartiere">-</span>
                </div>
                <div class="stat-row">
                    <span>Circoscrizione:</span>
                    <span class="stat-value" style="font-size: 11px;" id="statAlberiPerCircoscrizione">-</span>
                </div>
            </div>

            <h2 style="margin-top: 25px;"><i class="fas fa-list-check"></i> Classificazione CPC</h2>
            <div class="stats-box">
                <div class="stat-row">
                    <span style="color: #2cc15f;"><i class="fas fa-circle" style="color: #2cc15f;"></i> B - Bassa</span>
                    <span class="stat-value" id="statCpcB">0</span>
                </div>
                <div class="stat-row">
                    <span style="color: #f39c12;"><i class="fas fa-circle" style="color: #f39c12;"></i> C - Moderata</span>
                    <span class="stat-value" id="statCpcC">0</span>
                </div>
                <div class="stat-row">
                    <span style="color: #c164a1;"><i class="fas fa-circle" style="color: #c164a1;"></i> C/D - Elevata</span>
                    <span class="stat-value" id="statCpcCD">0</span>
                </div>
                <div class="stat-row">
                    <span style="color: #e74c3c;"><i class="fas fa-circle" style="color: #e74c3c;"></i> D - Estrema</span>
                    <span class="stat-value" id="statCpcD">0</span>
                </div>
            </div>

            <h2 style="margin-top: 25px;"><i class="fas fa-tools"></i> Cod. Lavorazione</h2>
            <div id="statLavorazione" style="font-size: 12px; color: #666;">
                <!-- Popolato dinamicamente -->
            </div>

            <h2 style="margin-top: 25px;"><i class="fas fa-leaf"></i> Benefici  Ambientali</h2>
            <div class="stats-box" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);">
                <div class="stat-row">
                    <span>Produzione O‚ÇÇ totale:</span>
                    <span class="stat-value" id="statTotalO2">0 kg/anno</span>
                </div>
                <div class="stat-row">
                    <span>Assorbimento CO‚ÇÇ totale:</span>
                    <span class="stat-value" id="statTotalCO2">0 kg/anno</span>
                </div>
            </div>

            <h2 style="margin-top: 25px;"><i class="fas fa-euro-sign"></i> Costi Lavorazione</h2>
            <div class="stats-box" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);">
                <div class="stat-row">
                    <span>Costo totale:</span>
                    <span class="stat-value" id="statTotalWorkingCost">0 ‚Ç¨</span>
                </div>
            </div>

    <!--    <h2><i class="fas fa-palette"></i> Legenda CPC</h2> -->
               <div class="legend">
                <h4>Classificazione</h4>
                <div class="legend-item">
                    <i class="fas fa-circle" style="color: #2ecc71; font-size: 16px;"></i>
                    <div><strong>B</strong> - Buono</div>
                </div>
                <div class="legend-item">
                    <i class="fas fa-circle" style="color: #f39c12; font-size: 16px;"></i>
                    <div><strong>C</strong> - Mediocre</div>
                </div>
                <div class="legend-item">
                    <i class="fas fa-circle" style="color: #e74c3c; font-size: 16px;"></i>
                    <div><strong>D</strong> - Cattivo</div> 
                </div>
            </div>
        </div>

        <div class="main">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="tree-details">
                <h3><i class="fas fa-leaf"></i> Dettagli selezionati</h3>
                <div id="selectedTreeInfo" class="details-grid">
                    <div class="no-data"><i class="fas fa-hand-pointer"></i> <b> Fai clic su un albero  per visualizzare o stampare la scheda informativa</b></div>
                </div>
		   </div>
            <div class="charts-container">
			                <div class="chart-box">
                    <h3><i class="fas fa-leaf"></i> Specie arboree principali</h3>
                    <div class="chart-wrapper">
                        <canvas id="speciesChart"></canvas>
                    </div>
                </div>	
				
                <div class="chart-box">
                    <h3><i class="fas fa-tree"></i> Stato salute - Classe Propensione Cedimento - CPC</h3>
                    <div class="chart-wrapper">
                        <canvas id="healthChart"></canvas>
                    </div>
                </div>
								
                <div class="chart-box">
                    <h3><i class="fas fa-location-dot"></i> Dimora</h3>
                    <div class="chart-wrapper">
                        <canvas id="siteChart"></canvas>
                    </div>
                </div>
				                <div class="chart-box">
                    <h3><i class="fas fa-chart-line"></i> Distribuzione altezze</h3>
                    <div class="chart-wrapper">
                        <canvas id="heightChart"></canvas>
                    </div>
                </div>

				<div class="chart-box" style="grid-column: 1 / -1;">
                    <h3><i class="fas fa-seedling"></i> Foglie totali per via nelle stagioni</h3>
                    <div class="chart-wrapper" style="height: 400px;">
                        <canvas id="seasonalLeavesChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ===== GESTIONE MODALE INFO =====
        document.getElementById('infoBtn').addEventListener('click', openInfoModal);
        document.getElementById('infoModal').addEventListener('click', function(e) {
            if (e.target === this) closeInfoModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeInfoModal();
        });

        function openInfoModal() {
            document.getElementById('infoModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

      // ===== CARICAMENTO DATI DA CSV =====
let rawGeoJson = null;

// Funzione per parsare CSV
function parseCSV(text) {
    const lines = text.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        const values = [];
        let current = '';
        let inQuotes = false;

        for (let char of lines[i]) {
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        values.push(current.trim());

        const row = {};
        headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
        });
        data.push(row);
    }
    return data;
}

// Funzione per caricare dati foglie stagionali
async function loadSeasonalLeavesData() {
    try {
        console.log('üì• Caricamento dati foglie stagionali...');

        let csvText;
        try {
            const response = await fetch('dati/16_tot_foglie.csv');
            if (!response.ok) throw new Error('Fetch fallito');
            csvText = await response.text();
        } catch (fetchError) {
            console.warn('‚ö†Ô∏è Fetch bloccato (CORS), uso XMLHttpRequest...');
            csvText = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'dati/16_tot_foglie.csv', true);
                xhr.onload = () => {
                    if (xhr.status === 200 || xhr.status === 0) {
                        resolve(xhr.responseText);
                    } else {
                        reject(new Error(`HTTP ${xhr.status}`));
                    }
                };
                xhr.onerror = () => reject(new Error('File non trovato'));
                xhr.send();
            });
        }

        const lines = csvText.trim().split('\n');
        if (lines.length < 2) {
            console.warn('‚ö†Ô∏è File foglie vuoto o invalido');
            return false;
        }

        // Organizza i dati per via (salta la prima riga dell'header)
        const dataByStreet = {};
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split(',');
            if (parts.length < 4) continue;

            const street = parts[0].trim();
            const season = parts[1].trim();
            const count = parseInt(parts[2]) || 0;
            const color = parts[3].trim();

            if (!street || !season) continue;

            if (!dataByStreet[street]) {
                dataByStreet[street] = {};
            }
            dataByStreet[street][season] = { count, color };
        }

        seasonalLeavesData = dataByStreet;
        console.log('‚úÖ Dati foglie stagionali caricati:', Object.keys(dataByStreet).length, 'vie');
        return true;
    } catch (error) {
        console.error('‚ùå Errore caricamento dati foglie:', error);
        return false;
    }
}

// Funzione per caricare CSV e convertire in GeoJSON
async function loadCSVData() {
    try {
        console.log('üì• Caricamento CSV in corso...');

        // Prova prima con fetch, poi fallback a XMLHttpRequest
        let csvText;
        try {
            const response = await fetch('dati/17_query_web.csv');
            if (!response.ok) throw new Error('Fetch fallito');
            csvText = await response.text();
        } catch (fetchError) {
            console.warn('‚ö†Ô∏è Fetch bloccato (CORS), uso XMLHttpRequest...');
            // Fallback per file:// protocol
            csvText = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'dati/17_query_web.csv', true);
                xhr.onload = () => {
                    if (xhr.status === 200 || xhr.status === 0) {
                        resolve(xhr.responseText);
                    } else {
                        reject(new Error(`HTTP ${xhr.status}`));
                    }
                };
                xhr.onerror = () => reject(new Error('File non trovato'));
                xhr.send();
            });
        }

        const csvData = parseCSV(csvText);

        const features = [];
        csvData.forEach(row => {
            if (!row['Lat'] || !row['Log']) return;

            const lat = parseFloat(row['Lat']);
            const lon = parseFloat(row['Log']);

            if (isNaN(lat) || isNaN(lon)) return;

            features.push({
                type: 'Feature',
                properties: {
                    'ID Pianta': row['ID Pianta'],
                    'Specie': row['Specie'],
                    'Sito Impianto': row['Sito Impianto'],
                    'h (m)': row['h (m)'],
                    'Diametro (cm)': row['Diametro (cm)'],
                    'Dist. sede stradale (m)': row['Dist. sede stradale (m)'],
                    'Dist. marciapiede (m)': row['Dist. marciapiede (m)'],
                    'CPC': row['CPC'],
                    'Cod. lavorazione/elenco prezzi': row['Cod. lavorazione/elenco prezzi'],
                    'Note': row['Note'],
                    'Descrizione': row['Descrizione'],
                    'Prezzo Unitario': row['Prezzo Unitario'],
                    'Odonimo': row['Odonimo'],
                    'UPL': row['UPL'],
                    'Quartiere': row['Quartiere'],
                    'Circoscrizione': row['Circoscrizione'],
                    'tipo_foglia': row['tipo_foglia']
                },
                geometry: {
                    type: 'Point',
                    coordinates: [lon, lat]
                }
            });
        });

        rawGeoJson = {
            type: 'FeatureCollection',
            features: features
        };

        console.log(`‚úÖ CSV caricato: ${features.length} alberi`);
        return true;
    } catch (error) {
        console.error('‚ùå Errore caricamento CSV:', error);
        alert('Errore nel caricamento dei dati. Verifica che il file dati/17_query_web.csv esista.');
        return false;
    }
}

   

// ===== VARIABILI GLOBALI (MODIFICA) =====
let allTrees = [];
let filteredTrees = [];
let map;
let markers = [];
let chartsInstances = {};
let selectedTree = null;  // AGGIUNTO: Traccia l'albero selezionato
let seasonalLeavesData = [];  // AGGIUNTO: Dati foglie stagionali

const cpcColors = {
     'B': '#2cc15f',
     'C': '#f39c12',
     'D': '#e74c3c',
     'C/D': '#c164a1'
};

        // ===== INIZIALIZZAZIONE =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Inizializzazione...');
    initMap();

    // Carica i dati dal CSV
    const loaded = await loadCSVData();
    if (!loaded) {
        console.error('‚ùå Impossibile caricare i dati');
        return;
    }

    // Carica i dati foglie stagionali (opzionale)
    const leavesLoaded = await loadSeasonalLeavesData();
    if (!leavesLoaded) {
        console.warn('‚ö†Ô∏è Continuazione senza dati foglie stagionali');
    }

    loadData();
    populateFilterSelects();
    initCharts();
    applyFilters();
    console.log('‚úÖ Inizializzazione completata');
});
        // ===== MAPPA =====
function initMap() {
    map = L.map('map').setView([38.147, 13.341], 15);
    
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        minZoom: 14,
		maxZoom: 18
    });
    
    const ctrLayer = L.tileLayer('https://siciliahub.github.io/Tiles/ctr_pa_2k/{z}/{x}/{y}.png', {
        attribution: '¬© CTC 2k Palermo - by @gbvitrano',
		minZoom: 14,
        maxZoom: 18    });
    
	    const googleSatLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: '¬© Google',
		minZoom: 14,
        maxZoom: 18
    });
    osmLayer.addTo(map);
    
    const baseMaps = {
        'OpenStreetMap': osmLayer,
        'CTC 2k Palermo': ctrLayer,
		'Google Satellite': googleSatLayer
    };
    
    L.control.layers(baseMaps).addTo(map);
    console.log('‚úÖ Mappa inizializzata');
}

        // ===== CARICAMENTO DATI =====
        function loadData() {
            try {
                rawGeoJson.features.forEach(feature => {
                    const props = feature.properties;
                    const coords = feature.geometry.coordinates;

                    const tree = {
                        id: props['ID Pianta'],
                        specie: props['Specie'] || '-',
                        sito: props['Sito Impianto'] || '-',
                        altezza: (() => {
                            const h = props['h (m)'];
                            if (!h || h === 'n/a') return null;
                            if (typeof h === 'string' && h.includes('-')) {
                                const val = parseFloat(h.split('-')[0]);
                                return isNaN(val) ? null : val;
                            }
                            const val = parseFloat(h);
                            return isNaN(val) ? null : val;
                        })(),
                        diametro: parseFloat(props['Diametro (cm)']) || null,
                        cpc: props['CPC'] || '-',
                        distStrada: parseFloat(props['Dist. sede stradale (m)']) || null,
                        distMarciapiede: props['Dist. marciapiede (m)'] || 'n/a',
                        codice: props['Cod. lavorazione/elenco prezzi'] || '-',
                        prezzo: (() => {
                            const p = props['Prezzo Unitario'];
                            if (!p) return 0;
                            if (typeof p === 'string') {
                                return parseFloat(p.replace('‚Ç¨', '').replace(',', '.')) || 0;
                            }
                            return parseFloat(p) || 0;
                        })(),
                        descrizione: props['Descrizione'] || '-',
                        descrizione_ccp: props['descrizione ccp'] || '-',
                        odonimo: props['Odonimo'] || '-',
                        upl: props['UPL'] || '-',
                        quartiere: props['Quartiere'] || '-',
                        circoscrizione: props['Circoscrizione'] || '-',
                        lat: coords[1],
                        lon: coords[0]
                    };
                    allTrees.push(tree);
                });

                filteredTrees = [...allTrees];
                console.log(`‚úÖ Caricati ${allTrees.length} alberi`);
            } catch (error) {
                console.error('‚ùå Errore caricamento:', error);
            }
        }

        // ===== FILTRI =====
        function populateFilterSelects() {
            const species = [...new Set(allTrees.map(t => t.specie))].sort();
            const specieSelect = document.getElementById('specieFilter');
            species.forEach(sp => {
                const opt = document.createElement('option');
                opt.value = sp;
                const count = allTrees.filter(t => t.specie === sp).length;
                opt.textContent = `${sp} (${count})`;
                specieSelect.appendChild(opt);
            });

            const sites = [...new Set(allTrees.map(t => t.sito))].sort();
            const siteSelect = document.getElementById('siteFilter');
            sites.forEach(site => {
                const opt = document.createElement('option');
                opt.value = site;
                const count = allTrees.filter(t => t.sito === site).length;
                opt.textContent = `${site} (${count})`;
                siteSelect.appendChild(opt);
            });

            // Filtri territoriali
            const odonomi = [...new Set(allTrees.map(t => t.odonimo).filter(o => o && o !== '-'))].sort();
            const odonimoSelect = document.getElementById('odonimoFilter');
            odonomi.forEach(od => {
                const opt = document.createElement('option');
                opt.value = od;
                const count = allTrees.filter(t => t.odonimo === od).length;
                opt.textContent = `${od} (${count})`;
                odonimoSelect.appendChild(opt);
            });

            const upls = [...new Set(allTrees.map(t => t.upl).filter(u => u && u !== '-'))].sort();
            const uplSelect = document.getElementById('uplFilter');
            upls.forEach(upl => {
                const opt = document.createElement('option');
                opt.value = upl;
                const count = allTrees.filter(t => t.upl === upl).length;
                opt.textContent = `${upl} (${count})`;
                uplSelect.appendChild(opt);
            });

            const quartieri = [...new Set(allTrees.map(t => t.quartiere).filter(q => q && q !== '-'))].sort();
            const quartiereSelect = document.getElementById('quartiereFilter');
            quartieri.forEach(qua => {
                const opt = document.createElement('option');
                opt.value = qua;
                const count = allTrees.filter(t => t.quartiere === qua).length;
                opt.textContent = `${qua} (${count})`;
                quartiereSelect.appendChild(opt);
            });

            const circoscrizioni = [...new Set(allTrees.map(t => t.circoscrizione).filter(c => c && c !== '-'))].sort();
            const circoscrizioneSelect = document.getElementById('circoscrizioneFilter');
            circoscrizioni.forEach(cir => {
                const opt = document.createElement('option');
                opt.value = cir;
                const count = allTrees.filter(t => t.circoscrizione === cir).length;
                opt.textContent = `${cir} (${count})`;
                circoscrizioneSelect.appendChild(opt);
            });
        }

        function updateHeightLabel() {
            document.getElementById('minHeightLabel').textContent = document.getElementById('minHeight').value;
        }

        function updateDiameterLabel() {
            document.getElementById('minDiameterLabel').textContent = document.getElementById('minDiameter').value;
        }

        function getCountForFilter(filterType, filterValue) {
            const specie = document.getElementById('specieFilter').value;
            const cpc = document.getElementById('cpcFilter').value;
            const site = document.getElementById('siteFilter').value;
            const minHeight = parseFloat(document.getElementById('minHeight').value);
            const minDiameter = parseFloat(document.getElementById('minDiameter').value);
            const odonimo = document.getElementById('odonimoFilter').value;
            const upl = document.getElementById('uplFilter').value;
            const quartiere = document.getElementById('quartiereFilter').value;
            const circoscrizione = document.getElementById('circoscrizioneFilter').value;

            let testValue = filterValue;

            return allTrees.filter(tree => {
                let match = true;

                // Applica il filtro corrente che stiamo testando
                if (filterType === 'specie') match = match && tree.specie === testValue;
                else if (specie) match = match && tree.specie === specie;

                if (filterType === 'cpc') match = match && tree.cpc === testValue;
                else if (cpc) match = match && tree.cpc === cpc;

                if (filterType === 'site') match = match && tree.sito === testValue;
                else if (site) match = match && tree.sito === site;

                if (filterType === 'odonimo') match = match && tree.odonimo === testValue;
                else if (odonimo) match = match && tree.odonimo === odonimo;

                if (filterType === 'upl') match = match && tree.upl === testValue;
                else if (upl) match = match && tree.upl === upl;

                if (filterType === 'quartiere') match = match && tree.quartiere === testValue;
                else if (quartiere) match = match && tree.quartiere === quartiere;

                if (filterType === 'circoscrizione') match = match && tree.circoscrizione === testValue;
                else if (circoscrizione) match = match && tree.circoscrizione === circoscrizione;

                match = match && (tree.altezza === null || tree.altezza >= minHeight);
                match = match && (tree.diametro === null || tree.diametro >= minDiameter);

                return match;
            }).length;
        }

        function applyFilters() {
            const specie = document.getElementById('specieFilter').value;
            const cpc = document.getElementById('cpcFilter').value;
            const site = document.getElementById('siteFilter').value;
            const minHeight = parseFloat(document.getElementById('minHeight').value);
            const minDiameter = parseFloat(document.getElementById('minDiameter').value);
            const odonimo = document.getElementById('odonimoFilter').value;
            const upl = document.getElementById('uplFilter').value;
            const quartiere = document.getElementById('quartiereFilter').value;
            const circoscrizione = document.getElementById('circoscrizioneFilter').value;

            filteredTrees = allTrees.filter(tree => {
                return (!specie || tree.specie === specie) &&
                       (!cpc || tree.cpc === cpc) &&
                       (!site || tree.sito === site) &&
                       (tree.altezza === null || tree.altezza >= minHeight) &&
                       (tree.diametro === null || tree.diametro >= minDiameter) &&
                       (!odonimo || tree.odonimo === odonimo) &&
                       (!upl || tree.upl === upl) &&
                       (!quartiere || tree.quartiere === quartiere) &&
                       (!circoscrizione || tree.circoscrizione === circoscrizione);
            });

            updateFilterInfo();
            updateFilterCounts();
            updatePageTitle(odonimo);
            updateMap();
            updateStats();
            updateCharts();
        }

        // Aggiorna il titolo della pagina con l'Odonimo selezionato
        function updatePageTitle(odonimo) {
            const titleElement = document.getElementById('pageTitle');
            if (odonimo) {
                titleElement.innerHTML = `<i class="fas fa-tree"></i>  Demo prototipale | alberi ${odonimo}`;
            } else {
                titleElement.innerHTML = `<i class="fas fa-tree"></i>  Demo prototipale | Verde Urbano`;
            }
        }

        function updateFilterInfo() {
            const specieValue = document.getElementById('specieFilter').value;
            const cpcValue = document.getElementById('cpcFilter').value;
            const siteValue = document.getElementById('siteFilter').value;
            const odonimoValue = document.getElementById('odonimoFilter').value;
            const uplValue = document.getElementById('uplFilter').value;
            const quartiereValue = document.getElementById('quartiereFilter').value;
            const circoscrizioneValue = document.getElementById('circoscrizioneFilter').value;

            document.getElementById('specieInfo').textContent =
                specieValue ? `${filteredTrees.filter(t => t.specie === specieValue).length}` : '';
            document.getElementById('cpcInfo').textContent =
                cpcValue ? `${filteredTrees.filter(t => t.cpc === cpcValue).length}` : '';
            document.getElementById('siteInfo').textContent =
                siteValue ? `${filteredTrees.filter(t => t.sito === siteValue).length}` : '';
            document.getElementById('odonimoInfo').textContent =
                odonimoValue ? `${filteredTrees.filter(t => t.odonimo === odonimoValue).length}` : '';
            document.getElementById('uplInfo').textContent =
                uplValue ? `${filteredTrees.filter(t => t.upl === uplValue).length}` : '';
            document.getElementById('quartiereInfo').textContent =
                quartiereValue ? `${filteredTrees.filter(t => t.quartiere === quartiereValue).length}` : '';
            document.getElementById('circoscrizioneInfo').textContent =
                circoscrizioneValue ? `${filteredTrees.filter(t => t.circoscrizione === circoscrizioneValue).length}` : '';
        }

        function updateFilterCounts() {
            // Aggiorna i conteggi dinamici per le opzioni dei select
            const specieSelect = document.getElementById('specieFilter');
            Array.from(specieSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('specie', opt.value);
                    opt.textContent = `${opt.value} (${count})`;
                    opt.disabled = count === 0;
                }
            });

            const siteSelect = document.getElementById('siteFilter');
            Array.from(siteSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('site', opt.value);
                    opt.textContent = `${opt.value} (${count})`;
                    opt.disabled = count === 0;
                }
            });

            const cpcSelect = document.getElementById('cpcFilter');
            Array.from(cpcSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('cpc', opt.value);
                    opt.disabled = count === 0;
                }
            });

            // Filtri territoriali
            const odonimoSelect = document.getElementById('odonimoFilter');
            Array.from(odonimoSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('odonimo', opt.value);
                    opt.textContent = `${opt.value} (${count})`;
                    opt.disabled = count === 0;
                }
            });

            const uplSelect = document.getElementById('uplFilter');
            Array.from(uplSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('upl', opt.value);
                    opt.textContent = `${opt.value} (${count})`;
                    opt.disabled = count === 0;
                }
            });

            const quartiereSelect = document.getElementById('quartiereFilter');
            Array.from(quartiereSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('quartiere', opt.value);
                    opt.textContent = `${opt.value} (${count})`;
                    opt.disabled = count === 0;
                }
            });

            const circoscrizioneSelect = document.getElementById('circoscrizioneFilter');
            Array.from(circoscrizioneSelect.options).forEach((opt, idx) => {
                if (idx > 0) {
                    const count = getCountForFilter('circoscrizione', opt.value);
                    opt.textContent = `${opt.value} (${count})`;
                    opt.disabled = count === 0;
                }
            });
        }

        function resetFilters() {
            document.getElementById('specieFilter').value = '';
            document.getElementById('cpcFilter').value = '';
            document.getElementById('siteFilter').value = '';
            document.getElementById('minHeight').value = '0';
            document.getElementById('minDiameter').value = '0';
            document.getElementById('odonimoFilter').value = '';
            document.getElementById('uplFilter').value = '';
            document.getElementById('quartiereFilter').value = '';
            document.getElementById('circoscrizioneFilter').value = '';
            updateHeightLabel();
            updateDiameterLabel();
            applyFilters();
        }

        // ===== MAPPA =====
        function updateMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            filteredTrees.forEach(tree => {
                const color = cpcColors[tree.cpc] || '#95a5a6';
                const radius = Math.max(3, Math.min(tree.diametro ? tree.diametro / 8 : 6, 15));

                const marker = L.circleMarker([tree.lat, tree.lon], {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2.5,
                    opacity: 1,
                    fillOpacity: 0.85
                }).addTo(map);

                const popupContent = `
                    <div style="font-family: Arial, sans-serif; font-size: 12px; min-width: 280px;">
                        <div style="background: #27ae60; color: white; padding: 8px; border-radius: 4px 4px 0 0; font-weight: bold; margin-bottom: 8px;">
                            <i class="fa fa-tree" aria-hidden="true"></i> Albero - ${tree.id}
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Specie arborea:</td>
                                <td style="padding: 6px;">${tree.specie}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Dimora:</td>
                                <td style="padding: 6px;">${tree.sito}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Altezza:</td>
                                <td style="padding: 6px;">${tree.altezza ? tree.altezza + ' m' : 'n/a'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Diametro:</td>
                                <td style="padding: 6px;">${tree.diametro ? tree.diametro + ' cm' : 'n/a'}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">CPC:</td>
                                <td style="padding: 6px; color: ${cpcColors[tree.cpc]}; font-weight: bold;">${tree.cpc}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Cod. lavorazione:</td>
                                <td style="padding: 6px;">${tree.codice}</td>
                            </tr>
							  <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Tipo lavorazione:</td>
                                <td style="padding: 6px;">${tree.descrizione}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 6px; font-weight: bold; color: #27ae60;">Prezzo unitari:</td>
                                <td style="padding: 6px;">‚Ç¨ ${tree.prezzo.toFixed(2)}</td>
                            </tr>
                        </table>
                        <div style="background: #f8f9fa; padding: 8px; margin-top: 8px; border-radius: 4px; border-left: 3px solid #3498db;">
                            <div style="font-weight: bold; color: #3498db; margin-bottom: 4px;"><i class="fa fa-map-marker-alt"></i> LOCALIZZAZIONE</div>
                            <table style="width: 100%; font-size: 11px;">
                                <tr>
                                    <td style="padding: 3px; font-weight: bold;">Strada:</td>
                                    <td style="padding: 3px;">${tree.odonimo || '-'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 3px; font-weight: bold;">UPL:</td>
                                    <td style="padding: 3px;">${tree.upl || '-'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 3px; font-weight: bold;">Quartiere:</td>
                                    <td style="padding: 3px;">${tree.quartiere || '-'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 3px; font-weight: bold;">Circoscrizione:</td>
                                    <td style="padding: 3px;">${tree.circoscrizione || '-'}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent, {maxWidth: 400});
                marker.on('click', () => showTreeDetails(tree));
                markers.push(marker);
            });

            if (filteredTrees.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.15), {maxZoom: 16});
            }
        }

// ===== FUNZIONI DI CALCOLO AMBIENTALE =====
/**
 * Calcola l'O2 prodotto in kg/anno basato su altezza e specie
 * Media europea: 11-15 kg O2/anno per albero maturo
 * Alberi giovani/piccoli: 5-8 kg O2/anno
 */
function calculateO2Production(tree) {
    let baseO2 = 10; // kg/anno base
    
    // Fattore altezza (alberi pi√π alti producono pi√π O2)
    if (tree.altezza) {
        const heightFactor = Math.min(1.5, tree.altezza / 10);
        baseO2 *= heightFactor;
    }
    
    // Fattore specie (alcuni alberi sono pi√π efficienti)
    const speciesMultiplier = {
        'Platanus orientalis': 1.4,
        'Magnolia grandiflora': 1.3,
        'Tilia tomentosa': 1.35,
        'Liquidambar styraciflua': 1.3,
        'Fraxinus ornus': 1.25,
        'Albizia julibrissin': 1.2,
        'Cupressus sempervirens': 1.15,
        'Phoenix canariensis': 1.1,
        'Quercus robur': 1.3,
        'Prunus cerasifera': 1.0
    };
    
    const multiplier = speciesMultiplier[tree.specie] || 1.0;
    return (baseO2 * multiplier).toFixed(2);
}

/**
 * Calcola la CO2 assorbita in kg/anno basato su altezza e specie
 * Media europea: 20-30 kg CO2/anno per albero maturo
 * Alberi giovani/piccoli: 10-15 kg CO2/anno
 */
function calculateCO2Absorption(tree) {
    let baseCO2 = 20; // kg/anno base
    
    // Fattore altezza
    if (tree.altezza) {
        const heightFactor = Math.min(1.8, tree.altezza / 8);
        baseCO2 *= heightFactor;
    }
    
    // Fattore diametro (alberi pi√π grandi assorbono pi√π CO2)
    if (tree.diametro) {
        const diameterFactor = Math.min(1.6, tree.diametro / 20);
        baseCO2 *= diameterFactor;
    }
    
    // Fattore specie
    const speciesMultiplier = {
        'Platanus orientalis': 1.5,
        'Magnolia grandiflora': 1.4,
        'Tilia tomentosa': 1.45,
        'Liquidambar styraciflua': 1.4,
        'Fraxinus ornus': 1.35,
        'Albizia julibrissin': 1.25,
        'Cupressus sempervirens': 1.2,
        'Phoenix canariensis': 1.15,
        'Quercus robur': 1.4,
        'Prunus cerasifera': 1.1
    };
    
    const multiplier = speciesMultiplier[tree.specie] || 1.0;
    return (baseCO2 * multiplier).toFixed(2);
}

/**
 * Calcola il costo di lavorazione per un albero
 */
function getWorkingCost(tree) {
    return tree.prezzo || 0;
}

function updateStats() {
    const total = allTrees.length;
    const filtered = filteredTrees.length;
    const altezze = filteredTrees.filter(t => t.altezza !== null).map(t => t.altezza);
    const diametri = filteredTrees.filter(t => t.diametro !== null).map(t => t.diametro);
    const species = new Set(filteredTrees.map(t => t.specie)).size;

    // Statistiche base
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statFiltered').textContent = filtered;
    document.getElementById('statAvgHeight').textContent = altezze.length > 0 ? 
        (altezze.reduce((a, b) => a + b, 0) / altezze.length).toFixed(1) + 'm' : '-';
    document.getElementById('statAvgDiameter').textContent = diametri.length > 0 ? 
        (diametri.reduce((a, b) => a + b, 0) / diametri.length).toFixed(1) + 'cm' : '-';
    document.getElementById('statSpecies').textContent = species;

    // ===== NUOVA PARTE: Conteggio CPC =====
    const cpcCount = {B: 0, C: 0, 'C/D': 0, D: 0};
    filteredTrees.forEach(t => {
        if (cpcCount.hasOwnProperty(t.cpc)) {
            cpcCount[t.cpc]++;
        }
    });
    document.getElementById('statCpcB').textContent = cpcCount.B;
    document.getElementById('statCpcC').textContent = cpcCount.C;
    document.getElementById('statCpcCD').textContent = cpcCount['C/D'];
    document.getElementById('statCpcD').textContent = cpcCount.D;

    // ===== NUOVA PARTE: Conteggio Cod. Lavorazione =====
    const lavorazioneCount = {};
    filteredTrees.forEach(t => {
        lavorazioneCount[t.codice] = (lavorazioneCount[t.codice] || 0) + 1;
    });
    
    // Ordina per frequenza decrescente
    const sortedLavorazioni = Object.entries(lavorazioneCount)
        .sort((a, b) => b[1] - a[1]);
    
    // Crea HTML per le lavorazioni
    let lavorazioneHTML = '';
    sortedLavorazioni.forEach(([cod, count]) => {
        lavorazioneHTML += `
            <div style="padding: 8px; margin-bottom: 8px; background: #f9f9f9; border-left: 3px solid #27ae60; border-radius: 4px;">
                <strong>${cod}</strong>: <span style="color: #27ae60; font-weight: 700;">${count}</span>
            </div>
        `;
    });
    
    document.getElementById('statLavorazione').innerHTML = lavorazioneHTML || 
        '<div style="padding: 8px; color: #999;">Nessun dato</div>';

    // ===== NUOVA PARTE: Calcoli ambientali e costi =====
    let totalO2 = 0;
    let totalCO2 = 0;
    let totalWorkingCost = 0;
    
    filteredTrees.forEach(t => {
        totalO2 += parseFloat(calculateO2Production(t));
        totalCO2 += parseFloat(calculateCO2Absorption(t));
        totalWorkingCost += getWorkingCost(t);
    });
    
    // Aggiorna i dati ambientali
    document.getElementById('statTotalO2').textContent = totalO2.toFixed(2) + ' kg/anno';
    document.getElementById('statTotalCO2').textContent = totalCO2.toFixed(2) + ' kg/anno';
    document.getElementById('statTotalWorkingCost').textContent = formatCurrency(totalWorkingCost);

    // ===== NUOVA PARTE: Dati Territorio =====
    const strade = new Set(filteredTrees.map(t => t.odonimo).filter(o => o !== '-'));
    const uplCount = {};
    const quartiereCount = {};
    const circoscrizioneCount = {};

    filteredTrees.forEach(t => {
        if (t.upl && t.upl !== '-') {
            uplCount[t.upl] = (uplCount[t.upl] || 0) + 1;
        }
        if (t.quartiere && t.quartiere !== '-') {
            quartiereCount[t.quartiere] = (quartiereCount[t.quartiere] || 0) + 1;
        }
        if (t.circoscrizione && t.circoscrizione !== '-') {
            circoscrizioneCount[t.circoscrizione] = (circoscrizioneCount[t.circoscrizione] || 0) + 1;
        }
    });

    // Formatta i dati per territorio (mostra solo i primi 2 valori)
    const formatTerritorioData = (data) => {
        const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
        if (entries.length === 0) return '-';
        if (entries.length === 1) return `${entries[0][0]}: ${entries[0][1]}`;
        // Mostra i primi 2 risultati
        const top2 = entries.slice(0, 2).map(([nome, count]) => `${nome}: ${count}`).join(', ');
        return entries.length > 2 ? `${top2}, ...` : top2;
    };

    document.getElementById('statTotalStrade').textContent = strade.size;
    document.getElementById('statAlberiPerUPL').textContent = formatTerritorioData(uplCount);
    document.getElementById('statAlberiPerQuartiere').textContent = formatTerritorioData(quartiereCount);
    document.getElementById('statAlberiPerCircoscrizione').textContent = formatTerritorioData(circoscrizioneCount);
}

// ===== FUNZIONE PER FORMATTARE VALUTA IN FORMATO ITALIANO =====
function formatCurrency(value) {
    if (value === 0 || !value) return '0,00 ‚Ç¨';

    // Converti in stringa con 2 decimali
    const fixed = value.toFixed(2);
    const [integerPart, decimalPart] = fixed.split('.');

    // Aggiungi separatore migliaia
    const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    // Ritorna nel formato italiano
    return `${formattedInteger},${decimalPart} ‚Ç¨`;
}

function showTreeDetails(tree) {
    selectedTree = tree;  // SALVA L'ALBERO SELEZIONATO
    
    // Calcola i valori ambientali
    const o2Production = calculateO2Production(tree);
    const co2Absorption = calculateCO2Absorption(tree);
    const workingCost = getWorkingCost(tree);
    
    const info = document.getElementById('selectedTreeInfo');
    info.innerHTML = `
        <div class="detail-item"><div class="detail-label">ID</div><div class="detail-value">${tree.id}</div></div>
        <div class="detail-item"><div class="detail-label">Specie arborea</div><div class="detail-value">${tree.specie}</div></div>
        <div class="detail-item"><div class="detail-label">Dimora</div><div class="detail-value">${tree.sito}</div></div>
        <div class="detail-item"><div class="detail-label">Altezza (m)</div><div class="detail-value">${tree.altezza || 'n/a'}</div></div>
        <div class="detail-item"><div class="detail-label">Diametro (cm)</div><div class="detail-value">${tree.diametro || 'n/a'}</div></div>
        <div class="detail-item"><div class="detail-label">classe propensione cedimento - CPC</div><div class="detail-value" style="color: ${cpcColors[tree.cpc]}">${tree.cpc}</div></div>
        <div class="detail-item"><div class="detail-label">Descrizione CPC</div><div class="detail-value">${tree.descrizione_ccp}</div></div>
        <div class="detail-item"><div class="detail-label">Cod. Lavorazione</div><div class="detail-value">${tree.codice}</div></div>
        <div class="detail-item" ><div class="detail-label">Tipo di lavorazione</div><div class="detail-value" style="font-size: 12px;">${tree.descrizione}</div></div>
        <div class="detail-item"><div class="detail-label">Prezzo unitario</div><div class="detail-value">${formatCurrency(tree.prezzo)}</div></div>

        <div class="detail-item" style="grid-column: 1/-1; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); border-left: 4px solid #3498db; border-radius: 6px;">
            <div class="detail-label" style="margin-bottom: 10px;"><i class="fa fa-map-marker-alt"></i> LOCALIZZAZIONE TERRITORIALE</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div class="detail-item" style="margin: 0;"><div class="detail-label">Strada (Odonimo)</div><div class="detail-value">${tree.odonimo || '-'}</div></div>
                <div class="detail-item" style="margin: 0;"><div class="detail-label">UPL</div><div class="detail-value">${tree.upl || '-'}</div></div>
                <div class="detail-item" style="margin: 0;"><div class="detail-label">Quartiere</div><div class="detail-value">${tree.quartiere || '-'}</div></div>
                <div class="detail-item" style="margin: 0;"><div class="detail-label">Circoscrizione</div><div class="detail-value">${tree.circoscrizione || '-'}</div></div>
            </div>
        </div>

        <div class="detail-item" style="grid-column: 1/-1; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border-left: 4px solid #27ae60; border-radius: 6px;">
            <div class="detail-label" style="margin-bottom: 10px;"><i class="fa-solid fa-seedling"></i> BENEFICI AMBIENTALI (all'anno)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #4caf50;">
                    <div style="font-size: 11px; color: #666; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px;">Assorbimento CO‚ÇÇ annuale:</div>
                    <div style="font-size: 18px; font-weight: 700; color: #27ae60;">${co2Absorption} kg/anno</div>
                </div>
                <div style="padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #2196f3;">
                    <div style="font-size: 11px; color: #666; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px;">Produzione O‚ÇÇ annuale:</div>
                    <div style="font-size: 18px; font-weight: 700; color: #1976d2;">${o2Production} kg/anno</div>
                </div>
            </div>
            <div style="font-size: 10px; color: #888; margin-top: 8px; font-style: italic;">
                Calcolati in base a: specie botanica, dimensioni, stato di salute
            </div>
        </div>

        <div class="detail-item" style="grid-column: 1/-1; margin-top: 10px;">
            <button class="pdf-button" onclick="generateTreePDF()" style="width: 100%; background: #27ae60; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"><i class="fa fa-download" aria-hidden="true"></i> Scarica PDF</button>
        </div>
    `;
}

function generateTreePDF() {
    if (!selectedTree) {
        alert('Seleziona un albero prima di generare il PDF');
        return;
    }

    const tree = selectedTree;
    
    // Crea un iframe invisibile
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body {
                    font-family: Arial, sans-serif;
                    color: #333;
                    padding: 20px;
                    line-height: 1.6;
                }
                h1 {
                    color: #27ae60;
                    text-align: center;
                    margin-bottom: 5px;
                    font-size: 24px;
                }
                .header {
                    text-align: center;
                    color: #888;
                    font-size: 12px;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #27ae60;
                    padding-bottom: 15px;
                }
                h2 {
                    color: #1e8449;
                    margin: 20px 0 10px 0;
                    font-size: 14px;
                    border-bottom: 2px solid #27ae60;
                    padding-bottom: 5px;
                }
                table {
                    width: 100%;
                    margin-bottom: 15px;
                    border-collapse: collapse;
                }
                td {
                    padding: 8px;
                    border-bottom: 1px solid #eee;
                }
                td:first-child {
                    font-weight: bold;
                    width: 40%;
                }
                .section {
                    margin-bottom: 20px;
                    padding: 10px;
                    background: #f9f9f9;
                    border-left: 3px solid #27ae60;
                    border-radius: 4px;
                }
                .footer {
                    text-align: center;
                    color: #888;
                    font-size: 10px;
                    margin-top: 30px;
                    border-top: 1px solid #ddd;
                    padding-top: 15px;
                }
            </style>
        </head>
        <body>
            <h1>Scheda Albero</h1>
            <div class="header">Dashboard Alberi Viale Emilia - Palermo</div>
            
            <h2>Informazioni Generali</h2>
            <table>
                <tr><td>ID Pianta:</td><td>${tree.id}</td></tr>
                <tr><td>Specie arborea:</td><td>${tree.specie}</td></tr>
                <tr><td>Dimora:</td><td>${tree.sito}</td></tr>
            </table>
            
            <h2>Dimensioni</h2>
            <table>
                <tr><td>Altezza (m):</td><td>${tree.altezza || 'n/a'}</td></tr>
                <tr><td>Diametro (cm):</td><td>${tree.diametro || 'n/a'}</td></tr>
            </table>

            <h2>Localizzazione Territoriale</h2>
            <table>
                <tr><td>Strada (Odonimo):</td><td>${tree.odonimo || '-'}</td></tr>
                <tr><td>UPL:</td><td>${tree.upl || '-'}</td></tr>
                <tr><td>Quartiere:</td><td>${tree.quartiere || '-'}</td></tr>
                <tr><td>Circoscrizione:</td><td>${tree.circoscrizione || '-'}</td></tr>
            </table>

            <h2>Stato di Salute e Interventi</h2>
            <table>
                <tr><td>CPC:</td><td style="color: ${cpcColors[tree.cpc]}; font-weight: bold;">${tree.cpc}</td></tr>
                <tr><td>Cod. Lavorazione:</td><td>${tree.codice}</td></tr>
                <tr><td>Prezzo Unitario (‚Ç¨):</td><td>${tree.prezzo.toFixed(2)}</td></tr>
            </table>
            
            <h2>Benefici Ambientali all'anno</h2>
            <div class="section" style="background: #e8f5e9; border-left: 4px solid #27ae60;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                    <div>
                        <div style="font-weight: bold; color: #27ae60; font-size: 12px; margin-bottom: 5px;">PRODUZIONE O‚ÇÇ ANNUALE</div>
                        <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${calculateO2Production(tree)} kg/anno</div>
                    </div>
                    <div>
                        <div style="font-weight: bold; color: #27ae60; font-size: 12px; margin-bottom: 5px;">ASSORBIMENTO CO‚ÇÇ ANNUALE</div>
                        <div style="font-size: 18px; font-weight: bold; color: #27ae60;">${calculateCO2Absorption(tree)} kg/anno</div>
                    </div>
                </div>
            </div>
			<hr>
			<div class="section" style="font-size: 11px;">
                <strong>Nota metodologica:</strong> I valori sono calcolati mediante modelli scientifici standardizzati (USDA Forest Service, Urban Forest Carbon Study), 
                considerando la specie botanica, le dimensioni dell'albero (altezza e diametro), e il suo stato fitosanitario (CPC). 
                Questi sono valori indicativi di sequestro di CO‚ÇÇ e produzione di O‚ÇÇ per singolo esemplare arboreo.
            </div>
			
            <h2>Descrizione Intervento</h2>
            <div class="section">${tree.descrizione}</div>
            <br>
            <h2>Descrizione Classe Propensione Cedimento CPC</h2>
            <div class="section">${tree.descrizione_ccp}</div>
            
<h2>Documentazione Fotografica</h2>
            <div style="margin-bottom: 20px;">
                <div style="margin-bottom: 15px; page-break-inside: avoid;">
                    <div style="font-weight: bold; color: #27ae60; font-size: 11px; margin-bottom: 8px;">üì∏ Cercine e Tronco</div>
                    <div style="width: 100%; height: 200px; background: linear-gradient(180deg, #8B7355 0%, #654321 100%); border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;">
                        <svg viewBox="0 0 400 300" style="width: 100%; height: 100%;">
                            <defs>
                                <radialGradient id="barkGrad" cx="50%" cy="30%">
                                    <stop offset="0%" style="stop-color:#9b8b7e;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#5d4e37;stop-opacity:1" />
                                </radialGradient>
                            </defs>
                            <rect width="400" height="300" fill="#8B7355"/>
                            <ellipse cx="200" cy="150" rx="100" ry="120" fill="url(#barkGrad)"/>
                            <path d="M120 150 Q120 120 150 100 Q180 90 200 85 Q220 90 250 100 Q280 120 280 150" fill="#704214" opacity="0.3"/>
                            <path d="M130 180 Q130 160 160 150 Q190 145 200 142 Q210 145 240 150 Q270 160 270 180" fill="#5d4e37" opacity="0.4"/>
                            <circle cx="180" cy="130" r="8" fill="#3a3a3a" opacity="0.5"/>
                            <circle cx="220" cy="125" r="6" fill="#3a3a3a" opacity="0.5"/>
                            <circle cx="150" cy="160" r="7" fill="#3a3a3a" opacity="0.4"/>
                            <circle cx="250" cy="165" r="9" fill="#3a3a3a" opacity="0.4"/>
                            <text x="200" y="270" font-size="16" fill="white" text-anchor="middle" font-weight="bold">Cercine e Tronco</text>
                        </svg>
                    </div>
                    <div style="font-size: 9px; color: #999; margin-top: 5px; text-align: center;">Dettaglio del cercine e del tronco</div>
                </div>
                
                <div style="margin-bottom: 15px; page-break-inside: avoid;">
                    <div style="font-weight: bold; color: #27ae60; font-size: 11px; margin-bottom: 8px;">üì∏ Albero Intero</div>
                    <div style="width: 100%; height: 200px; background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%); border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <svg viewBox="0 0 400 300" style="width: 100%; height: 100%;">
                            <defs>
                                <radialGradient id="crown1" cx="50%" cy="40%">
                                    <stop offset="0%" style="stop-color:#2d8f2d;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#1a5e1a;stop-opacity:1" />
                                </radialGradient>
                                <radialGradient id="crown2" cx="45%" cy="35%">
                                    <stop offset="0%" style="stop-color:#3a9d3a;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#2d7a2d;stop-opacity:1" />
                                </radialGradient>
                            </defs>
                            <ellipse cx="200" cy="250" rx="180" ry="40" fill="#8B7355" opacity="0.3"/>
                            <rect x="175" y="170" width="50" height="90" fill="#8B6F47"/>
                            <ellipse cx="200" cy="120" rx="85" ry="90" fill="url(#crown1)"/>
                            <ellipse cx="140" cy="100" rx="65" ry="70" fill="url(#crown2)"/>
                            <ellipse cx="260" cy="100" rx="65" ry="70" fill="url(#crown2)"/>
                            <ellipse cx="200" cy="60" rx="60" ry="65" fill="#2d8f2d"/>
                            <circle cx="120" cy="130" r="20" fill="#3a9d3a" opacity="0.6"/>
                            <circle cx="280" cy="130" r="20" fill="#3a9d3a" opacity="0.6"/>
                            <rect x="0" y="260" width="400" height="40" fill="#8B7355" opacity="0.2"/>
                            <text x="200" y="290" font-size="14" fill="#333" text-anchor="middle" font-weight="bold">Albero Intero</text>
                        </svg>
                    </div>
                    <div style="font-size: 9px; color: #999; margin-top: 5px; text-align: center;">Vista completa dell'albero</div>
                </div>
                
                <div style="margin-bottom: 15px; page-break-inside: avoid;">
                    <div style="font-weight: bold; color: #27ae60; font-size: 11px; margin-bottom: 8px;">üì∏ Chioma</div>
                    <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #87CEEB 0%, #C8E6C9 100%); border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <svg viewBox="0 0 400 300" style="width: 100%; height: 100%;">
                            <defs>
                                <radialGradient id="leaf1" cx="50%" cy="40%">
                                    <stop offset="0%" style="stop-color:#4db84d;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#1a5e1a;stop-opacity:1" />
                                </radialGradient>
                                <radialGradient id="leaf2" cx="45%" cy="35%">
                                    <stop offset="0%" style="stop-color:#66bb6a;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#2d7a2d;stop-opacity:1" />
                                </radialGradient>
                            </defs>
                            <ellipse cx="200" cy="150" rx="110" ry="120" fill="url(#leaf1)"/>
                            <ellipse cx="150" cy="110" rx="75" ry="85" fill="url(#leaf2)"/>
                            <ellipse cx="250" cy="110" rx="75" ry="85" fill="url(#leaf2)"/>
                            <ellipse cx="200" cy="70" rx="65" ry="75" fill="#4db84d"/>
                            <circle cx="130" cy="150" r="25" fill="#66bb6a" opacity="0.7"/>
                            <circle cx="270" cy="150" r="25" fill="#66bb6a" opacity="0.7"/>
                            <circle cx="200" cy="200" r="28" fill="#66bb6a" opacity="0.8"/>
                            <path d="M180 90 L190 120 L200 100 L210 125 L220 95" stroke="#2d7a2d" stroke-width="2" fill="none" opacity="0.5"/>
                            <text x="200" y="270" font-size="14" fill="#333" text-anchor="middle" font-weight="bold">Dettaglio Chioma</text>
                        </svg>
                    </div>
                    <div style="font-size: 9px; color: #999; margin-top: 5px; text-align: center;">Dettaglio della chioma e fogliame</div>
                </div>
            </div>
			<p>
			Questa applicazione √® stata sviluppata a scopo dimostrativo e educativo per illustrare le potenzialit√† dei sistemi di monitoraggio urbano e gestione dati geospaziali. I dati visualizzati sono sintetici e non rappresentano situazioni reali certificate.</p>
			<div class="footer">Documento DEMO generato il ${new Date().toLocaleDateString('it-IT')}</div>
        </body>
        </html>
    `;
    
    iframeDoc.open();
    iframeDoc.write(htmlContent);
    iframeDoc.close();
    
    // Attendi il rendering e stampa
    setTimeout(() => {
        iframe.contentWindow.print();
        // Rimuovi l'iframe dopo la stampa
        setTimeout(() => {
            document.body.removeChild(iframe);
        }, 100);
    }, 500);
}
        // ===== GRAFICI =====
		
function initCharts() {
    console.log('üìä Inizializzazione grafici...');

    // Altezze
    const heightCtx = document.getElementById('heightChart');
    if (heightCtx && heightCtx.getContext) {
        chartsInstances.height = new Chart(heightCtx, {
            type: 'bar',
            data: {
                labels: ['6-8m', '8-10m', '10-12m', '12-14m', '14-16m', '>16m'],
                datasets: [{
                    label: 'Alberi',
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: '#27ae60',
                    borderColor: '#1e8449',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: { y: { beginAtZero: true } }
            },
            plugins: [{
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            if (value > 0) {
                                ctx.fillStyle = '#333';
                                ctx.font = 'bold 12px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                const barHeight = bar.height;
                                const barY = bar.y;
                                const labelY = barY + barHeight / 2;
                                
                                // Se la barra √® abbastanza alta (> 35px), etichetta dentro in bianco
                                if (barHeight > 35) {
                                    ctx.fillStyle = 'white';
                                    ctx.fillText(value, bar.x, labelY);
                                } 
                                // Altrimenti etichetta fuori sopra la barra in grigio pi√π visibile
                                else {
                                    ctx.fillStyle = '#555';
                                    ctx.fillText(value, bar.x, barY - 10);
                                }
                            }
                        });
                    });
                }
            }]
        });
    }

    // CPC - TRASFORMATO IN GRAFICO A COLONNE VERTICALI
    const healthCtx = document.getElementById('healthChart');
    if (healthCtx && healthCtx.getContext) {
        chartsInstances.health = new Chart(healthCtx, {
            type: 'bar',
            data: {
                labels: ['B', 'C', 'C/D', 'D'],
                datasets: [{
                    label: 'Alberi',
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#2cc15f', '#f39c12', '#c164a1', '#e74c3c'],
                    borderColor: ['#25a84f', '#d68910', '#a04d85', '#c0392b'],
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'x',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: { 
                    y: { beginAtZero: true }
                }
            },
            plugins: [{
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    
                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        const meta = chart.getDatasetMeta(datasetIndex);
                        
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            
                            if (value > 0) {
                                ctx.fillStyle = '#333';
                                ctx.font = 'bold 12px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                const barHeight = bar.height;
                                const barY = bar.y;
                                const barX = bar.x;
                                
                                if (barHeight > 35) {
                                    ctx.fillStyle = 'white';
                                    ctx.fillText(value, barX, barY + barHeight / 2);
                                } else {
                                    ctx.fillStyle = '#555';
                                    ctx.fillText(value, barX, barY - 10);
                                }
                            }
                        });
                    });
                }
            }]
        });
    }

    // Specie
    const speciesCtx = document.getElementById('speciesChart');
    if (speciesCtx && speciesCtx.getContext) {
        chartsInstances.species = new Chart(speciesCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Esemplari',
                    data: [],
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: { x: { beginAtZero: true } }
            },
            plugins: [{
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            if (value > 0) {
                                ctx.fillStyle = '#333';
                                ctx.font = 'bold 11px Arial';
                                ctx.textBaseline = 'middle';
                                const barWidth = bar.width;
                                
                                // Se la barra √® abbastanza lunga (> 50px), etichetta dentro in bianco
                                if (barWidth > 45) {
                                    ctx.fillStyle = 'white';
                                    ctx.textAlign = 'center';
                                    ctx.fillText(value, bar.x - 35, bar.y);
                                } 
                                // Altrimenti etichetta fuori a destra in grigio
                                else {
                                    ctx.fillStyle = '#555';
                                    ctx.textAlign = 'left';
                                    ctx.fillText(value, bar.x + barWidth + 8, bar.y);
                                }
                            }
                        });
                    });
                }
            }]
        });
    }

    // Sito impianto
    const siteCtx = document.getElementById('siteChart');
    if (siteCtx && siteCtx.getContext) {
        chartsInstances.site = new Chart(siteCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Esemplari',
                    data: [],
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: { x: { beginAtZero: true } }
            },
            plugins: [{
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];
                            if (value > 0) {
                                ctx.fillStyle = '#333';
                                ctx.font = 'bold 11px Arial';
                                ctx.textBaseline = 'middle';
                                const barWidth = bar.width;
                                
                                // Se la barra √® abbastanza lunga (> 50px), etichetta dentro in bianco
                                if (barWidth > 45) {
                                    ctx.fillStyle = 'white';
                                    ctx.textAlign = 'left';
                                    ctx.fillText(value, bar.x - 35, bar.y);
                                } 
                                // Altrimenti etichetta fuori a destra in grigio
                                else {
                                    ctx.fillStyle = '#555';
                                    ctx.textAlign = 'left';
                                    ctx.fillText(value, bar.x + barWidth + 8, bar.y);
                                }
                            }
                        });
                    });
                }
            }]
        });
    }

    // Foglie stagionali per via
    const seasonalLeavesCtx = document.getElementById('seasonalLeavesChart');
    if (seasonalLeavesCtx && seasonalLeavesCtx.getContext) {
        chartsInstances.seasonalLeaves = new Chart(seasonalLeavesCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Primavera',
                        data: [],
                        backgroundColor: '#FAD5A5',
                        borderColor: '#F4C78D',
                        borderWidth: 2
                    },
                    {
                        label: 'Estate',
                        data: [],
                        backgroundColor: '#B0C4DE',
                        borderColor: '#9BB3D0',
                        borderWidth: 2
                    },
                    {
                        label: 'Autunno',
                        data: [],
                        backgroundColor: '#D2691E',
                        borderColor: '#C05A18',
                        borderWidth: 2
                    },
                    {
                        label: 'Inverno',
                        data: [],
                        backgroundColor: '#000080',
                        borderColor: '#000066',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.x.toLocaleString('it-IT') + ' foglie';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        stacked: false,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('it-IT');
                            }
                        }
                    },
                    y: {
                        stacked: false
                    }
                }
            }
        });

        // Popola il grafico con i dati
        updateSeasonalLeavesChart();
    }

    console.log('‚úÖ Grafici inizializzati');
}

// Funzione per aggiornare il grafico delle foglie stagionali
function updateSeasonalLeavesChart() {
    if (!chartsInstances.seasonalLeaves) {
        console.warn('‚ö†Ô∏è Grafico foglie stagionali non inizializzato');
        return;
    }

    if (!seasonalLeavesData || Object.keys(seasonalLeavesData).length === 0) {
        console.warn('‚ö†Ô∏è Nessun dato foglie stagionali disponibile');
        return;
    }

    const streets = Object.keys(seasonalLeavesData).sort();
    const primaveraData = [];
    const estateData = [];
    const autunnoData = [];
    const invernoData = [];

    streets.forEach(street => {
        const data = seasonalLeavesData[street];
        primaveraData.push((data['Primavera'] && data['Primavera'].count) || 0);
        estateData.push((data['Estate'] && data['Estate'].count) || 0);
        autunnoData.push((data['Autunno'] && data['Autunno'].count) || 0);
        invernoData.push((data['Inverno'] && data['Inverno'].count) || 0);
    });

    chartsInstances.seasonalLeaves.data.labels = streets;
    chartsInstances.seasonalLeaves.data.datasets[0].data = primaveraData;
    chartsInstances.seasonalLeaves.data.datasets[1].data = estateData;
    chartsInstances.seasonalLeaves.data.datasets[2].data = autunnoData;
    chartsInstances.seasonalLeaves.data.datasets[3].data = invernoData;
    chartsInstances.seasonalLeaves.update();

    console.log('üìä Grafico foglie stagionali aggiornato con', streets.length, 'vie');
}


    // ===== DOWNLOAD RELAZIONE TECNICA DA FILE LINKATO =====
    function downloadRelazione() {
        // URL del file PDF - MODIFICA CON L'URL REALE DEL TUO FILE
        const pdfUrl = 'https://palermohub.github.io/Verde_Urbano/Analisi_Viale_Emilia_Completa.pdf';
        
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.download = 'Relazione_Tecnica_Viale_Emilia.pdf';
        
        try {
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log('‚úÖ Download relazione tecnica avviato');
        } catch (error) {
            console.error('‚ùå Errore nel download:', error);
            alert('Errore nel download. Verifica che l\'URL sia corretto.');
        }
    }

    // ===== STAMPA MAPPA IN PDF =====
    function printMapPdf() {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generazione...';
        btn.disabled = true;

        setTimeout(() => {
            try {
                // Crea un contenitore temporaneo per il PDF - LANDSCAPE
                const pdfContainer = document.createElement('div');
                pdfContainer.style.width = '297mm';
                pdfContainer.style.height = '210mm';
                pdfContainer.style.padding = '12mm';
                pdfContainer.style.fontFamily = 'Segoe UI, Arial, sans-serif';
                pdfContainer.style.backgroundColor = '#ffffff';
                pdfContainer.style.display = 'flex';
                pdfContainer.style.flexDirection = 'column';
                pdfContainer.style.fontSize = '12px';
                pdfContainer.style.color = '#333';

                // HEADER
                const header = document.createElement('div');
                header.style.flex = '0 0 auto';
                header.style.borderBottom = '3px solid #27ae60';
                header.style.paddingBottom = '8mm';
                header.style.marginBottom = '8mm';
                const odonimoFilter = document.getElementById('odonimoFilter').value;
                const titleText = odonimoFilter ? `alberi ${odonimoFilter}` : 'Verde Urbano';
                header.innerHTML = `
                    <div style="font-size: 18px; font-weight: 700; color: #27ae60; margin-bottom: 4px;">
                        <i class="fas fa-tree"></i> Demo prototipale | ${titleText}
                    </div>
                    <div style="font-size: 11px; color: #666;">
                        Palermo 2025 - Monitoraggio e analisi dello stato di salute del verde urbano
                    </div>
                `;
                pdfContainer.appendChild(header);

                // SEZIONE MAPPA (la parte centrale - la pi√π grande)
                const mapSection = document.createElement('div');
                mapSection.style.flex = '1 1 auto';
                mapSection.style.display = 'flex';
                mapSection.style.justifyContent = 'center';
                mapSection.style.alignItems = 'center';
                mapSection.style.marginBottom = '8mm';
                mapSection.style.overflow = 'hidden';

                // Clona la mappa
                const mapElement = document.getElementById('map');
                const mapClone = mapElement.cloneNode(true);
                mapClone.style.width = '100%';
                mapClone.style.height = '110mm';
                mapClone.style.borderRadius = '4px';
                mapClone.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                mapSection.appendChild(mapClone);

                pdfContainer.appendChild(mapSection);

                // FOOTER
                const footer = document.createElement('div');
                footer.style.flex = '0 0 auto';
                footer.style.borderTop = '2px solid #27ae60';
                footer.style.paddingTop = '8mm';
                footer.style.fontSize = '10px';
                footer.style.lineHeight = '1.4';
                footer.style.color = '#555';
                footer.innerHTML = `
                    <div style="font-weight: 700; color: #27ae60; margin-bottom: 4px; font-size: 11px;">
                        <i class="fas fa-lightbulb"></i> Natura della Demo
                    </div>
                    <div style="text-align: justify;">
                        Questa √® una demo prototipale che mostra i dati di monitoraggio relativi a una singola strada (Viale Emilia). Il progetto completo di cui fa parte √® molto pi√π articolato e comprende ulteriori strade, zone e funzionalit√† avanzate non ancora rappresentate in questa versione.
                    </div>
                `;
                pdfContainer.appendChild(footer);

                // Aggiungi temporaneamente al DOM per il rendering
                pdfContainer.style.position = 'fixed';
                pdfContainer.style.top = '-5000px';
                pdfContainer.style.left = '0';
                pdfContainer.style.zIndex = '-1';
                document.body.appendChild(pdfContainer);

                // Usa html2canvas per catturare l'elemento
                html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.98);
                    
                    // Crea il PDF con jsPDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // Calcola le dimensioni per adattare l'immagine al PDF
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = pdfWidth;
                    const imgHeight = (canvas.height * pdfWidth) / canvas.width;

                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    // Aggiungi timbro "work in progress" ruotato di 45¬∞
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const centerX = pageWidth / 2
                    const centerY = pageHeight / 1.5;
                    
                    // Imposta le propriet√† del timbro
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(30);
                    pdf.setTextColor(220, 80, 80); // Rosso
                    
                    // Crea uno stato grafico con trasparenza
                    pdf.setGState(new pdf.GState({opacity: 0.75}));
                    
                    // Ruota il testo di 45¬∞
                    pdf.text('Work in progress - Mappa non corretta', centerX, centerY, {
                        align: 'center',
                        baseline: 'middle',
                        angle: 25
                    });
                    
                    pdf.save('Mappa_Viale_Emilia.pdf');

                    console.log('‚úÖ Mappa stampata in PDF con layout landscape');
                    
                    // Rimuovi il contenitore temporaneo
                    document.body.removeChild(pdfContainer);
                    
                    // Ripristina il pulsante
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                }).catch(error => {
                    console.error('‚ùå Errore nella stampa:', error);
                    alert('Errore nella generazione del PDF. Riprova.');
                    if (document.body.contains(pdfContainer)) {
                        document.body.removeChild(pdfContainer);
                    }
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });

            } catch (error) {
                console.error('‚ùå Errore nella stampa:', error);
                alert('Errore nella generazione del PDF. Riprova.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }, 100);
    }

        function updateCharts() {
            console.log('üìä Aggiornamento grafici...');

            // Altezze - Corretto con 6 range
            const heights = [0, 0, 0, 0, 0, 0];
            filteredTrees.forEach(t => {
                if (t.altezza !== null && !isNaN(t.altezza)) {
                    if (t.altezza < 8) heights[0]++;
                    else if (t.altezza < 10) heights[1]++;
                    else if (t.altezza < 12) heights[2]++;
                    else if (t.altezza < 14) heights[3]++;
                    else if (t.altezza < 16) heights[4]++;
                    else heights[5]++;
                }
            });
            if (chartsInstances.height) {
                chartsInstances.height.data.datasets[0].data = heights;
                chartsInstances.height.update();
            }

            // CPC
            const cpcCounts = {B: 0, C: 0, 'C/D': 0, D: 0 };
            filteredTrees.forEach(t => {
                if (cpcCounts.hasOwnProperty(t.cpc)) cpcCounts[t.cpc]++;
            });
            if (chartsInstances.health) {
                chartsInstances.health.data.datasets[0].data = [cpcCounts.B, cpcCounts.C, cpcCounts['C/D'], cpcCounts.D];
                chartsInstances.health.update();
            }

            // Specie
            const speciesCount = {};
            filteredTrees.forEach(t => {
                speciesCount[t.specie] = (speciesCount[t.specie] || 0) + 1;
            });
            const sortedSpecies = Object.entries(speciesCount).sort((a, b) => b[1] - a[1]);
            if (chartsInstances.species) {
                chartsInstances.species.data.labels = sortedSpecies.map(s => s[0].substring(0, 15));
                chartsInstances.species.data.datasets[0].data = sortedSpecies.map(s => s[1]);
                chartsInstances.species.update();
            }

            // Siti
            const siteCount = {};
            filteredTrees.forEach(t => {
                siteCount[t.sito] = (siteCount[t.sito] || 0) + 1;
            });
            const sortedSites = Object.entries(siteCount).sort((a, b) => b[1] - a[1]);
            if (chartsInstances.site) {
                chartsInstances.site.data.labels = sortedSites.map(s => s[0]);
                chartsInstances.site.data.datasets[0].data = sortedSites.map(s => s[1]);
                chartsInstances.site.update();
            }

            console.log('‚úÖ Grafici aggiornati');
        }
    </script>

    <!-- Footer -->
    <footer>
        <h3><i class="fas fa-lightbulb"></i> Natura della Demo</h3>
        <p>Questa √® una demo prototipale che mostra i dati di monitoraggio relativi a una singola strada (Viale Emilia). Il progetto completo di cui fa parte √® molto pi√π articolato e comprende ulteriori strade, zone e funzionalit√† avanzate non ancora rappresentate in questa versione.</p>
    </footer>
</body>
</html>
